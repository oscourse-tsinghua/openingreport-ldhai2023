## 题目
微内核的异步化改造
## 摘要

以seL4为代表的现代微内核操作系统将同步IPC作为进程间通信的主要方式，同时辅助需要内核转发的通知机制来实现用户态的中断处理和异步通信。然而随着微内核生态的发展，内核有必要支持需要进行大量和频繁的系统调用和IPC的应用，同步系统调用和IPC导致了大量的上下文切换和二级缓存失效，同时由于阻塞等待导致系统无法充分利用多核的性能；此外，seL4中的通知机制广泛用于用户态驱动、线程间异步通信等，但由于需要内核进行转发，因此其中的上下文切换和缓存失效在某些平台将造成不可忽视开销。

本文聚焦微内核的异步通信机制，在利用用户态中断技术改造seL4的通知机制，使得信号无需通过内核转发，减少上下切换的开销。同时在内核中提供异步系统调用接口，在用户态运行时自动收集异步的系统调用，批量地注册到内核中，进一步减少系统的上下文切换开销，并提升用户态的并发粒度。

关键词：微内核；异步系统调用；中断。
## 1. 选题依据

### 1.1 选题背景

微内核从被提出以来，最大的性能瓶颈就是IPC，30年前Liedtke[1]提出的L4通过对内核系统的重新设计，证明了微内核的IPC也可以很快，之后以seL4[2]为代表的微内核的IPC框架也基本延续了最初的L4，以同步IPC作为主要的通信方式，同时引入异步的notification机制来简化多线程程序设计，并提升多核的利用率[3]。然而随着软件性能要求不断提升，seL4中的IPC通信方式并不能很好的满足。

首先是软件对系统有了新的要求，随着软件复杂性的提升，系统级软件如数据库管理系统、网络服务器等，需要进行大量的系统调用，这要求操作系统能够以快速高效的形式处理大量系统调用[4]，而微内核将操作系统的大部分服务（如网络协议栈、文件系统等）移到用户态，从而面临比宏内核更严峻的挑战。此外，新出现的硬件漏洞如Meltdown[5] 和 Spectre[6] 漏洞促使 Linux 使用 KPTI 补丁[7]来分离用户程序和内核的页表，进一步增加了陷入内核的开销，seL4 中也有类似的机制。最后，外设速度越来越快，而现代微内核的外设驱动往往存在于用户态，外设中断被转化为通知信号，需要用户态驱动主动陷入内核来进行接收，这在很大程度上成为了外设驱动的性能瓶颈。

综上所述，以seL4为代表的现代微内核在IPC架构的设计上并不能完全满足当前及未来的软硬件发展趋势，主要体现在以下两个方面：
- 缺乏高效地处理大量IPC的机制。
- 缺乏在用户态高效地中断接收的机制。

### 1.2 国内外研究现状

以seL4为代表的现代微内核大多致力于减少单个IPC在内核中的路径开销，通过减少IPC路径的解码和调度流程，减少内存拷贝等方式来减少单个IPC的开销，却很少从整个系统的角度来考虑减少用户态向内核态发起IPC请求的次数，从而减少系统调用的切换开销。而减少用户态与内核态切换开销的方式主要有两类：
- 第一类方法通过将触发系统调用的线程部分指令段代理给内核态[8, 9, 10, 11]，或者将内核的部分功能代码映射到和用户程序同一个地址空间[12, 13]，来减少内核与用户态的切换开销。
- 第二类方法则是允许用户空间对多个系统调用请求排队，并仅通过一个系统调用来将他们一起发出[14]。

原始的L4微内核使用同步的IPC机制作为唯一的IPC手段，而以seL4为代表的现代微内核为了更好的利用多核性能，加入类似信号量的通知机制同步用户态进程，同时通知机制也作为了用户态程序处理硬件中断的主要手段。在此引入的中断传递开销

而对于异步信号处理的评判标准则主要是响应时延以及CPU资源利用率。当前业界主流的处理异步信号的方式有两种：轮询和中断，轮询以牺牲CPU利用率来减少响应时延，而中断则相反。虽然有些研究[15, 16]已经证明了在某些高速设备上使用轮询的延迟和开销会低于中断，但对于大部分低速设备而言，使用中断仍然是更好的选择。而seL4中的通知机制是一种以软件形式实现的、由内核进行转发的异步处理机制，即使对于高速设备而言，使用轮询的优势已经被陷入内核的开销所大幅削减，因此中断将会是更好的异步处理形式。

综上所述，现代微内核以同步IPC的方式简化内核路径，通过各种方法提升单个IPC的速度，却也因为同步的形式限制了微内核系统的整体性能，本文将从用户态的角度，通过异步的形式减少用户态发起IPC的次数，同时辅助硬件支持通知机制，减少用户态和内核态的切换开销，提升整个系统的性能。