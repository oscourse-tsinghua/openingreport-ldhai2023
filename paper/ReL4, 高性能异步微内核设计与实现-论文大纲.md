# 摘要

以seL4为代表的现代微内核操作系统将同步IPC作为进程间通信的主要方式，同时借助需要内核转发的通知机制来实现用户态的中断处理和异步通信。然而随着微内核生态的发展，大量和频繁的系统调用和IPC的应用越来越需要微内核的支持，然而同步系统调用和IPC导致了大量的上下文切换和二级缓存失效，同时由于阻塞等待导致系统无法充分利用多核的性能；虽然微内核对异步信号有一定的支持，但都需要内核进行转发，其中的上下文切换和缓存失效在某些平台和场景下将造成不可忽视的开销。

本文聚焦微内核的异步通信机制，利用用户态中断技术改造seL4的通知机制，使得信号无需通过内核转发，减少上下切换的开销。同时利用无需内核转发的通知机制，设计和实现无需陷入内核的异步系统调用和异步IPC框架，在提升用户态并发度的同时，减少用户态和内核态的切换次数，提升系统的整体性能。

关键词：微内核；异步；用户态中断。

# 1. 引言

- 微内核将大部分系统功能转移到用户态，应用程序请求一些公共服务通过IPC的形式来进行。而现代微内核大多以同步IPC作为进程间的通信方式，同时用异步的通知机制作为辅助。
- 然而无论是同步IPC还是异步通知机制都需要内核的参与转发，对于需要进行大量IPC请求的系统而言，用户态-内核-用户态的上下文切换将成为系统的性能瓶颈。
- 本文利用用户态中断来改造异步通知机制，使得异步通知无需通过内核转发，避免了特权级的切换和缓存失效。同时在此基础上设计和实现了一套完全异步的IPC和系统调用框架，大幅度减少了特权级的切换次数，提升系统的整体性能。
- 后续将从背景与动机、系统设计、实现细节、性能评估四个方面介绍我们的工作。

# 2. 背景与设计目标

## 2.1 介绍背景
- 介绍微内核的发展，以及改进IPC性能在微内核中的已有方法，从而导出现代微内核中IPC的两个问题：
	- 同步IPC对多核利用效率不高。
	- 性能瓶颈：特权级切换。
- 介绍特权级切换产生的开销：
	- 上下文切换。
	- 页表切换。
	- 缓存失效，快表污染。
- 介绍减少特权级切换的相关工作，以及相关的优缺点：
	- 通过将用户态和内核态的功能扁平化来减少内核与用户态的切换开销，eg: unikernel、UB等。
	- 允许用户空间对多个系统调用请求排队，批量系统调用的方式均摊上下文切换的成本，如FlexSC等。
## 2.2 设计目标
- 希望利用用户态中断减少特权级的切换次数，提升系统性能。
- 希望兼容原始的notification借口，保证兼容性。
- 希望利用Rust语言协程机制自动收集IPC请求和系统调用请求，提升易用性。

# 3. 设计

## 3.1 基于用户态中断的微内核异步通知机制
## 3.2 异步IPC
## 3.3 异步系统调用


# 4. 实现
- 无锁的环形缓冲区。
- 自适应的混合轮训。
- 优先级机制。

# 5. 性能评估
- micro-benchmark：与同步IPC的平均开销进行对比
	- 实验设置。
	- 性能分析。
	- 结论。
-  macro-benchmark: 基于axi-net网卡驱动和smoltcp来实现用户态网络协议栈，同步调用和异步调用进行对比。
	- 实验设置。
	- 性能分析。
	- 结论。

# 6. 总结
