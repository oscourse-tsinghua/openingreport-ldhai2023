# 摘要

微内核在安全性、稳定性和模块化方面相比于宏内核有着极大的优势。然而以 seL4 为代表的现代微内核在设计上有两点不足:1)通知机制需要内核转发;2)系统调用和同步IPC需要频繁的出入内核,这两点不足导致了特权级切换成为系统的性能瓶颈。本文设计并实现了高性能异步微内核，通过聚焦微内核的异步通信机制，设计了无需内核转发的U-notification，减少了特权级切换的开销;同时在U-notification 基础上，借助共享内存和异步编程机制，设计了无需陷入内核的异步系统调用和异步 IPC 框架，在提升用户态并发度的同时，进一步减少特权级的切换次数。经测试，ReL4将 IPC性能最高提升了3x，在 IPC 频繁的系统(如网络服务器)中将吞吐量提升了 1x。

关键词：微内核；异步；用户态中断。

# 1. 引言

- 微内核将大部分系统功能转移到用户态，应用程序请求一些公共服务通过IPC的形式来进行，而现代微内核大多以同步IPC作为进程间的通信方式，同时用异步的通知机制作为辅助。这些设计在安全性、模块化等方面相比宏内核具有显著优势
- 然而设计上的两点不足成为系统的性能瓶颈：
	- 通知机制需要内核转发。
	- 系统调用和同步IPC需要频繁的出入内核。
- 工作内容介绍：本文利用用户态中断来改造异步通知机制，使得异步通知无需通过内核转发，避免了特权级的切换和缓存失效。同时在此基础上设计和实现了一套完全异步的IPC和系统调用框架，大幅度减少了特权级的切换次数，提升系统的整体性能。
- 难点与挑战：
	- 用户态中断与原始通知机制的兼容。
	- 避免盲目中断，减少中断次数。
	- 如何更好地利用空闲CPU资源

# 2. 背景与相关工作

## 2.1 介绍背景
- 介绍微内核的发展，以及改进IPC性能在微内核中的已有方法，从而导出现代微内核中IPC的两个问题：
	- 同步IPC对多核利用效率不高。
	- 性能瓶颈：特权级切换。
- 介绍特权级切换产生的开销：
	- 上下文切换。
	- 页表切换。
	- 缓存失效，快表污染。
## 2.2 介绍相关工作
- 内核路径优化。
	- 主要介绍了seL4等现代化微内核作出的软件相关优化
- 上下文切换优化。
	- 软件优化：
		- 系统架构优化。
		- 软件处理方式优化。
		- 编译器优化。
	- 硬件优化：
		- 借助特殊指令集（虚拟化）
		- 借助特殊硬件

# 3. 设计

系统设计的简介：
 - U-notification
 - 共享内存
 - 异步运行时
## 3.1 基于用户态中断的微内核异步通知机制（U-notification）
- 权限控制。
	- Capabililty机制介绍。
	- UINTC介绍。
	- 兼容性设计。
- 通信接口的兼容性设计。
## 3.2 异步IPC
- 共享内存
- 异步运行时
- 优先级调度
## 3.3 异步系统调用
- 与异步IPC的联系与区别
- 执行优先级和CPU抢占。

# 4. 性能评估
- 实验设置。
- 功能测试。
	- 成功通过seL4test所有测例。
	- 分析seL4和reL4在seL4test的性能表现。
- 内存分配服务器：
- 同步IPC vs. 异步IPC:。
- TCP服务器测试
# 6. 总结
- 总结研究内容，强调研究结果：本文利用用户态中断机制在微内核中设计了一套无需陷入内核的异步IPC框架，并基于异步IPC框架对系统调用也进行了异步化改造，从而设计出一个完全异步的高性能微内核，经测试，异步IPC将IPC的性能最高提升了387.8%，在IPC频繁的系统中（如网络服务器）将系统性能最高提升15%。
- 论述研究意义，提升论文定位：异步IPC和异步系统调用主要是为了提升高频度、上下文无关的IPC和系统调用请求的整体处理性能，因此在并发度高的系统中拥有卓越的表现，此外，在并发度低的情况下，我们仍然通过用户态中断这种开销相对较小的方式来取代特权级切换，从而在一定程度上弥补了低并发度情况下引入异步运行时带来的额外开销。
- 展望后续研究，进行简单介绍：我们期望用硬件实现异步运行时中的频繁操作（如fetch、wake等），从而尽可能消除运行时对性能的影响，在低并发度的情况下也能取得良好的性能。