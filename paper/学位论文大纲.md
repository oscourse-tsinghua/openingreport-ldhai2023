# 摘要

微内核在安全性、稳定性和模块化方面相比于宏内核有着极大的优势。然而以 seL4 为代表的现代微内核将同步进程间通信（IPC）作为主要的通信方式，并提供异步通知机制提升用户态并发性，简化编程模型，其在设计上有三点缺陷，其一，在支持同步IPC的情况下冗余地支持了异步通知，这违背了微内核的最小化原则；其二，通知机制依赖内核的转发；其三，系统调用和同步 IPC 需要频繁地进出内核，后两点导致了特权级切换成为系统的性能瓶颈。本文旨在设计一款基于用户态中断的高性能异步微内核ReL4，来解决上述问题，在保证功能完备性的前提下，在内核态移除同步IPC，精简微内核机制；同时为了提升IPC性能，我们基于用户态中断，设计了无需内核转发的 U-notification，减少了特权级切换的开销；为了简化编程模型，提升用户态并发度，我们在 U-notification 基础上，借助异步编程机制和硬件调度队列，设计了无需陷入内核的异步系统调用和异步 IPC 框架，进一步减少特权级的切换次数。经测试验证，ReL4 将 IPC 性能最高提升了 3x，在 IPC 频繁的系统(如网络服务器)中将吞吐量提升了 1x，证明了ReL4在高并发系统上有着良好的性能。

关键词：微内核；异步；用户态中断。

# 1. 引言
- 微内核的设计理念与优势
	- 将大部分系统功能转移到用户态，应用程序请求一些公共服务通过IPC的形式来进行，而现代微内核大多以同步IPC作为进程间的通信方式，同时用异步的通知机制作为辅助。这些设计在安全性、模块化等方面相比宏内核具有显著优势。
- 现代微内核的设计缺陷：
	- 冗余支持异步IPC（违反最小化原则）
	- 同步IPC与异步通知需要内核转发，上下文切换成为性能瓶颈。
- 工作内容介绍：
	- 在内核态移除同步IPC，精简微内核机制
	- 基于用户态中断，在内核态设计U-notification，减少上下文切换，提升性能。
	- 基于异步编程机制和硬件调度队列，在用户态设计异步运行时，并实现无需陷入内核的异步系统调用和异步 IPC 框架，提升用户态易用性。
	- 基于硬件调度队列，减少调度开销，提升低并发下的IPC性能。

# 2. 背景与相关工作

## 2.1 介绍背景
- 介绍微内核的发展
	- 微内核的IPC发展思路，从而导出现代微内核中IPC的两个问题：
		- 违反内核最小化原则。
		- 同步IPC对多核利用效率不高。
		- 性能瓶颈：特权级切换。
- 介绍特权级切换产生的开销：
	- 上下文切换。
	- 页表切换。
	- 缓存失效，快表污染。
## 2.2 介绍相关工作
- 内核路径优化。
	- 主要介绍了seL4等现代化微内核作出的软件相关优化
- 上下文切换优化。
	- 软件优化：
		- 系统架构优化。
		- 软件处理方式优化。
		- 编译器优化。
	- 硬件优化：
		- 借助特殊指令集（虚拟化）
		- 借助特殊硬件
- 本文用到的技术：
	- 软件方面：
		- 异步编程介绍
		- 用户态中断介绍
		- 硬件调度队列（TAIC介绍）

# 3. 系统设计
设计目标：
- 在内核态移除同步IPC，仅支持异步通知机制，精简微内核机制。
	- 提升性能：减少特权级切换（通知机制）
	- 提升易用性：用户态运行时。
## 3.1 通知机制
- 用户态通知用户态
- 内核态通知用户态
- 内核态通知用户态
- 内核态通知内核态
### 3.1.1 U-notification
介绍U-notification的设计。
### 3.1.2 自适应混合轮询
介绍通知机制的时机。

## 3.2 异步运行时
- 共享缓冲区
- 协程
- 优先级调度
- 异步系统调用与异步IPC的hook库
- U-notification管理

# 4. 系统实现
- 新增系统调用接口
- 异步IPC
- 异步系统调用。
# 5. 兼容性讨论
- U-notification的兼容性
- 异步IPC的兼容性。
- 异步系统调用的兼容性。

# 4. 性能评估
- 实验设置。
- 功能测试。
	- 成功通过seL4test所有测例。
	- 分析seL4和reL4在seL4test的性能表现。
- U-notification vs. 原始notification
	- 原始notification与U-notification的阶段耗时分析
- 同步IPC vs. 异步IPC。
	- 阶段耗时分析。
- TCP服务器测试
- 内存分配服务器
# 6. 总结
- 总结研究内容，强调研究结果：本文利用用户态中断机制在微内核中设计了一套无需陷入内核的异步IPC框架，并基于异步IPC框架对系统调用也进行了异步化改造，从而设计出一个完全异步的高性能微内核，经测试，异步IPC将IPC的性能最高提升了387.8%，在IPC频繁的系统中（如网络服务器）将系统性能最高提升1x。
- 论述研究意义，提升论文定位：异步IPC和异步系统调用主要是为了提升高频度、上下文无关的IPC和系统调用请求的整体处理性能，因此在并发度高的系统中拥有卓越的表现，此外，在并发度低的情况下，我们仍然通过用户态中断和硬件调度队列这种开销相对较小的方式来取代特权级切换，从而在一定程度上弥补了低并发度情况下引入异步运行时带来的额外开销。